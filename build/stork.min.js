"use strict";!function(t,e){function i(t){return!!(t&&t.constructor&&t.call&&t.apply)}function n(t){return"object"==typeof t&&null!==t}function s(t){return"number"==typeof t&&!isNaN(t)}function r(t){return"undefined"==typeof t}function a(t){return"undefined"!=typeof t}function h(t,e,i,n){return a(t)?t:a(e)?e:a(i)?i:n}function c(t,e){for(var i in t)e[i]=t[i]}function u(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function o(){return u()+u()+"-"+u()+"-"+u()+"-"+u()+"-"+u()+u()+u()}function f(t,e){var i=e.priority-t.priority;return 0===i?0:0>i?-1:1}function l(t){if(!l.chosen){if(t)for(var e=0;e<d.adapters.length;e++){var i=d.adapters[e];if(i.name===t&&i.definition.valid())return i}d.adapters.sort(f);for(var e=0;e<d.adapters.length;e++){var i=d.adapters[e];if(i.definition.valid())return l.chosen=i}}return l.chosen}function d(t,e,i){this.options=t=t||{},this.key=h(t.key,"id"),this.name=h(t.name,""),this.lazy=h(t.lazy,!1),this.cache=new p,this.pending=[],this.initialized=!1,this.loaded=!1,this.adapter=l(t.adapter),c(this.adapter.definition,this);for(var n=0;n<d.plugins.length;n++)d.plugins[n](this);this.initializing=this.init(this.options,e,i)}function v(t,e,i,n){this.context=t,this.root=n||this,this.next=null,this.nextFromSuccess=null,this.state=v.PENDING,this.successes=[],this.failures=[],this.errors=[],this.args=null,this.$queue(e,i)}function p(t){this.reset(),this.putMap(t)}var g=JSON.stringify,m=JSON.parse;d.prototype={decode:m,encode:g,handlePending:function(t,e,i){var n=!this.initialized;return n&&this.pending.push({method:t,arguments:Array.prototype.slice.call(e),promise:i}),n},finishInitialization:function(t,e){if(!this.initialized){this.initialized=!0,t.$success(e);for(var i=0;i<this.pending.length;i++){var n=this.pending[i],s=n.method.apply(this,n.arguments);n.promise&&n.promise.$bindTo(s)}this.pending=null}return this},finishReload:function(t){if(t.$pending()){var e=this.cache;this.initialized?t.$success([e.values,e.okeys]):this.finishInitialization(t,[e.values,e.okeys])}},valid:function(){throw"Stork.valid is not implemented"},init:function(t,e,i){throw"Stork.init is not implemented"},reload:function(t,e){throw"Stork.reload is not implemented"},then:function(t){return t.apply(this)},getMany:function(t,e,i){var n=new v(this,e,i);if(this.handlePending(this.get,arguments,n))return n;for(var s=0,r=[],a=function(e){return function(i){r[e]=i,++s===t.length&&n.$success([r,t])}},h=function(e){n.$failure([t,e])},c=0;c<t.length;c++)this.get(t[c],a(c),h);return n},get:function(t,i,n){var s=new v(this,i,n);if(this.handlePending(this.get,arguments,s))return s;var r;try{r=this.encode(t)}catch(a){s.$failure([t,a])}return s.$pending()&&(this.cache.has(r)?s.$success([this.cache.get(r),t]):this.loaded?s.$success([e,t]):this._get(t,r,s)),s},_get:function(t,e,i){throw"Stork._get is not implemented"},destroy:function(t,e){var i=new v(this,t,e);return this.handlePending(this.destroy,arguments,i)?i:(this._destroy(i),i)},_destroy:function(t){throw"Stork._destroy is not implemented"},save:function(t,e,i){var n=new v(this,e,i);if(this.handlePending(this.save,arguments,n))return n;var s=this.key,a=t[s];r(a)&&(a=t[s]=o());var h=function(t,e){n.$success([e])},c=function(t,e,i){n.$failure([e,i])};return this.put(a,t,h,c),n},batch:function(t,e,i){var n=new v(this,e,i);if(this.handlePending(this.batch,arguments,n))return n;for(var s=0,r=function(){++s===t.length&&n.$success([t])},a=function(e){n.$failure([t,s,e])},h=0;h<t.length&&!n.state;h++)this.save(t[h],r,a);return n},put:function(t,e,i,n){var s=new v(this,i,n);if(this.handlePending(this.put,arguments,s))return s;var r,a;try{r=this.encode(t),a=g(e)}catch(h){s.$failure([t,e,h])}return s.$pending()&&this._put(t,e,r,a,s),s},_put:function(t,e,i,n,s){throw"Stork._put is not implemented"},remove:function(t,i,n){var s=new v(this,i,n);if(this.handlePending(this.remove,arguments,s))return s;var r;try{r=this.encode(t)}catch(a){s.$failure([t,a])}if(s.$pending())if(this.loaded&&!this.cache.has(r))s.$success([e,t]);else{var h=this.cache.get(r);this._remove(t,r,h,s)}return s},_remove:function(t,e,i,n){throw"Stork._remove is not implemented"},removeMany:function(t,e,i){var n=new v(this,e,i);if(this.handlePending(this.removeMany,arguments,n))return n;for(var s=[],r=0,a=function(e){return function(i){s[e]=i,++r===t.length&&n.$success([s,t])}},h=function(t){n.$failure([s,r,t])},c=0;c<t.length;c++)this.remove(t[c],a(c),h);return n},each:function(t,e){if(!i(t)||this.handlePending(this.each,arguments))return this;var n=this,s=function(e,i){for(var s=0;s<e.length;s++)t.call(n,e[s],i[s])};if(this.loaded){var r=this.cache.okeys,a=this.cache.values;s(a,r)}else this.reload(s,e);return this},size:function(t,e){var i=new v(this,t,e);return this.handlePending(this.size,arguments,i)?i:(this.loaded?i.$success([this.cache.size()]):this._size(i),i)},_size:function(t){throw"Stork._size is not implemented"},all:function(t,e){var i=new v(this,t,e);if(this.handlePending(this.all,arguments,i))return i;var n=function(t,e){i.$success([t,e])},s=function(t){i.$failure([t])};if(this.loaded){var r=this.cache.okeys,a=this.cache.values;n(a,r)}else this.reload(n,s);return i}},v.PENDING=0,v.FAILURE=1,v.SUCCESS=2,v.CHAINED=3,v.prototype={then:function(t,i){return this.$queue(t,i),this.next||(this.next=new v(this.context,e,e,this)),this.state&v.SUCCESS?this.$handleSuccesses():this.state===v.FAILURE&&this.$handleFailures(),this.next},error:function(t){return i(t)&&(this.root.errors.push(t),this.state===v.FAILURE&&this.$handleFailures()),this},$bindTo:function(t,e){var i=this;t.then(function(){i.context=t.context,i.$success(h(e,t.args))},function(){i.context=t.context,i.$failure(h(e,t.args))})},$pending:function(){return this.state===v.PENDING},$queue:function(t,e){i(t)&&this.successes.push(t),i(e)&&this.failures.push(e)},$handleSuccesses:function(){for(var t=this.successes,e=0;e<t.length;e++){var i=t[e],n=i.apply(this.context,this.args);n instanceof v&&!this.nextFromSuccess&&(this.nextFromSuccess=n)}t.length=0,this.$handleNext()},$handleNext:function(){var t=this.next,e=this.nextFromSuccess;t&&e&&this.state===v.SUCCESS&&(t.$bindTo(e),this.state=v.CHAINED)},$success:function(t){this.state===v.PENDING&&(this.args=t||[],this.state=v.SUCCESS,this.$handleSuccesses())},$handleFailures:function(){for(var t=this.failures,e=0;e<t.length;e++)t[e].apply(this.context,this.args);t.length=0;for(var i=this.root.errors,n=[this.args[this.args.length-1]],e=0;e<i.length;e++)i[e].apply(this.context,n);i.length=0},$failure:function(t){this.state===v.PENDING&&(this.args=t||[],this.state=v.FAILURE,this.$handleFailures())}},p.prototype={reset:function(){return this.values=[],this.keys=[],this.okeys=[],this.indices={},this},put:function(t,e,i){return t in this.indices?this.values[this.indices[t]]=e:(this.indices[t]=this.values.length,this.values.push(e),this.keys.push(t),this.okeys.push(i)),this},putMap:function(t){if(t instanceof p)for(var e=t.keys,i=t.values,s=t.okeys,r=0;r<e.length;r++)this.put(e[r],i[r],s[r]);else if(n(t))for(var a in t)this.put(a,t[a],a);return this},get:function(t){return this.values[this.indices[t]]},remove:function(t){var e=this.indices[t];return s(e)&&this.removeAt(e),this},removeAt:function(t){var e=this.keys[t],i=this.values.pop(),n=this.keys.pop(),s=this.okeys.pop();return t<this.values.length&&(this.values[t]=i,this.keys[t]=n,this.okeys[t]=s,this.indices[n]=t),delete this.indices[e],this},indexOf:function(t){return h(this.indices[t],-1)},has:function(t){return t in this.indices},hasOverlap:function(t){for(var e=this.keys,i=t.indices,n=0;n<e.length;n++)if(e[n]in i)return!0;return!1},size:function(){return this.values.length}},d.plugins=[],d.plugin=function(t){return i(t)&&d.plugins.push(t),d},d.adapters=[],d.adapter=function(t,e,n){return d.adapters.push({name:t,priority:e,definition:i(n)?n():n}),d},d.adapter("chrome-storage-local",4,function(){function t(){return chrome&&chrome.runtime&&chrome.runtime.lastError}var i=window.chrome&&chrome.storage?chrome.storage.local:!1;return{encode:function(t){return this.prefix+g(t)},decode:function(t){return m(t.substring(this.prefix.length))},valid:function(){if(!i)return!1;try{var t=Math.random(),e={};return e[t]=t,i.set(e),i.remove(t),!0}catch(n){return!1}},init:function(t,e,i){var n=new v(this,e,i);return this.prefix=h(t.prefix,this.name+"-"),this.lazy?this._finishInitialization(n,[this]):n.$bindTo(this.reload(),[this]),n},reload:function(e,n){var s=new v(this,e,n),r=this,a=this.prefix,h=new p;return i.get(null,function(e){if(t())s.$failure([t()]);else{for(var i in e)i.substring(0,a.length)===a&&h.put(i,e[i],r.decode(i));r.cache=h,r.loaded=!0,r.finishReload(s)}}),s},_get:function(n,s,r){i.get(s,function(i){if(t())r.$failure([n,t()]);else if(i.length){var s=m(i[0]);r.$success([s,n])}else r.$success([e,n])})},_destroy:function(e){var n=this,s=function(){i.remove(this.cache.keys,function(){t()?e.$failure([t()]):(n.cache.reset(),e.$success())})},r=function(t){e.$failure([t])};this.loaded?s():this.reload(s,r)},_put:function(e,n,s,r,a){var h=this,c={};c[s]=n,i.set(c,function(){if(t())a.$failure([e,n,t()]);else{var i=h.cache.get(s);h.cache.put(s,n,e),a.$success([e,n,i])}})},_remove:function(e,n,s,r){var a=this;i.remove(n,function(){t()?r.$failure([e,t()]):(a.cache.remove(n),r.$success([s,e]))})},_size:function(t){var e=function(e,i){t.$success([e.length])},i=function(e){t.$failure([e])};this.reload(e,i)}}}),d.adapter("local-storage",3,function(){var t=window.localStorage;return{encode:function(t){return this.prefix+g(t)},decode:function(t){return m(t.substring(this.prefix.length))},valid:function(){if(!t)return!1;try{var e=Math.random();return t.setItem(e,e),t.removeItem(e),!0}catch(i){return!1}},init:function(t,e,i){var n=new v(this,e,i);return this.prefix=h(t.prefix,this.name+"-"),this.lazy?this.finishInitialization(n,[this]):n.$bindTo(this.reload(),[this]),n},reload:function(e,i){var n=new v(this,e,i),s=this.prefix,r=new p;try{for(var a=0;a<t.length;a++){var h=t.key(a);if(h.substring(0,s.length)===s){var c=t.getItem(h),u=m(c),o=this.decode(h);r.put(h,u,o)}}this.cache=r,this.loaded=!0}catch(f){n.$failure([f])}return this.finishReload(n),n},_destroy:function(e){var i=this,n=this.prefix,s=function(n){try{for(var s=0;s<n.length;s++)t.removeItem(n[s])}catch(r){e.$failure([r])}e.$pending()&&(i.cache.reset(),e.$success())};if(this.loaded)s(this.cache.keys);else{var r=[];try{for(var a=0;a<t.length;a++){var h=t.key(a);h.substring(0,n.length)===n&&r.push(h)}}catch(c){e.$failure([c])}e.$pending()&&s(r)}},_get:function(e,i,n){try{var s=t.getItem(i),r=m(s);n.$success([r,e])}catch(a){n.$failure([e,a])}},_put:function(e,i,n,s,r){try{t.setItem(n,s)}catch(a){r.$failure([e,i,a])}if(r.$pending()){var h=this.cache.get(n);this.cache.put(n,i,e),r.$success([e,i,h])}},_remove:function(e,i,n,s){try{t.removeItem(i)}catch(r){s.$failure([e,r])}s.$pending()&&(this.cache.remove(i),s.$success([n,e]))},_size:function(t){var e=function(e,i){t.$success([e.length])},i=function(e){t.$failure([e])};this.reload(e,i)}}}),d.adapter("memory",1,{valid:function(){return!0},init:function(t,e,i){var n=new v(this,e,i);return this.loaded=!0,this.finishInitialization(n,[this]),n},reload:function(t,e){var i=new v(this,t,e);return this.finishReload(i),i},_destroy:function(t){this.cache.reset(),t.$success()},_put:function(t,e,i,n,s){var r=this.cache.get(i);this.cache.put(i,e,t),s.$success([t,e,r])},_remove:function(t,e,i,n){this.cache.remove(e),n.$success([i,t])}}),d.adapter("webkit-sqlite",5,function(){function t(t,e){return t.replace(/\{(\d+)\}/g,function(t,i){return i=parseInt(i),isNaN(i)||0>i||i>=e.length?t:e[i]})}var i="stork",n="CREATE TABLE IF NOT EXISTS {0} (id TEXT PRIMARY KEY, value TEXT)",s="SELECT value FROM {0} WHERE id = ?",a="SELECT id, value FROM {0}",c="INSERT OR REPLACE INTO {0} (id, value) VALUES (?, ?)",u="DELETE FROM {0} WHERE id = ?",f="SELECT COUNT(*) as count FROM {0}",l="DELETE FROM {0}",d="DELETE FROM {0} WHERE id IN ({1})";return{valid:function(){return!!window.openDatabase},init:function(e,r,o){var d=new v(this,r,o),p=h(e.database,i),g=h(e.size,65536),m=h(e.version,"1.0"),$=this,y=function(t,e){d.$failure([e])},S=function(t){t.executeSql($.SQL_CREATE,[],E,y)},E=function(t,e){$.lazy?$.finishInitialization(d,[$]):d.$bindTo($.reload(),[$])};return this.SQL_CREATE=t(n,[this.name]),this.SQL_SELECT=t(s,[this.name]),this.SQL_SELECT_ALL=t(a,[this.name]),this.SQL_INSERT=t(c,[this.name]),this.SQL_DELETE=t(u,[this.name]),this.SQL_DESTROY=t(l,[this.name]),this.SQL_COUNT=t(f,[this.name]),this.db=openDatabase(p,m,p,g),this.db.transaction(S,y),d},reload:function(t,e){var i=new v(this,t,e),n=this,s=function(t,e){i.$failure([e])},r=function(t){t.executeSql(n.SQL_SELECT_ALL,[],a,s)},a=function(t,e){var s=new p;try{for(var r=0;r<e.rows.length;r++){var a=e.rows[r],h=m(a.value),c=m(a.id);s.put(a.id,h,c)}n.cache=s,n.loaded=!0}catch(u){i.$failure([u])}n.finishReload(i)};return this.db.readTransaction(r,s),i},_get:function(t,i,n){var s=this,r=function(e,i){n.$failure([t,i])},a=function(t){t.executeSql(s.SQL_SELECT,[i],h,r)},h=function(r,a){var h=e;try{var c=a.rows[0];c&&c.value!==e&&(h=m(c.value))}catch(u){n.$failure([t,u])}n.$pending()&&(h!==e?(s.cache.put(i,h,t),n.$success([h,t])):n.$success([e,t]))};this.db.readTransaction(a,r)},_destroy:function(t){var e=this,i=function(t){t.executeSql(e.SQL_DESTROY,[],n,s)},n=function(i,n){e.cache.reset(),t.$success()},s=function(e,i){t.$failure([i])};this.db.transaction(i,s)},_put:function(t,e,i,n,s){var r=this,a=function(t){t.executeSql(r.SQL_INSERT,[i,n],h,c)},h=function(n,a){var h=r.cache.get(i);r.cache.put(i,e),s.$success([t,e,h])},c=function(i,n){s.$failure([t,e,n])};this.db.transaction(a,c)},batch:function(t,e,i){var n=new v(this,e,i);if(this.handlePending(this.batch,arguments,n))return n;var s=this,a=this.key,h=0,c=[];try{for(var u=0;u<t.length;u++){var f=t[u],l=f[a];r(l)&&(l=f[a]=o()),c.push({value:f,key:l,rawKey:g(l),rawValue:g(f)})}}catch(d){return n.$failure([t,h,d]),n}var p=function(t){for(var e=0;e<c.length;e++){var i=c[e];t.executeSql(s.SQL_INSERT,[i.rawKey,i.rawValue],m,$)}},m=function(e,i){if(++h===t.length&&n.$pending()){for(var r=0;r<c.length;r++){var a=c[r];s.cache.put(a.rawKey,a.value,a.key)}n.$success([t])}},$=function(e,i){n.$failure([t,h,i])};return this.db.transaction(p,$),n},_remove:function(t,e,i,n){var s=this,r=function(t){t.executeSql(s.SQL_DELETE,[e],a,h)},a=function(r,a){s.cache.remove(e),n.$success([i,t])},h=function(e,i){n.$failure([t,i])};this.db.transaction(r,h)},removeMany:function(e,i,n){var s=new v(this,i,n);if(this.handlePending(this.removeMany,arguments,s))return s;var r=this,a=[],h=[],c=[],u="",o=function(t){t.executeSql(u,a,f,l)},f=function(t,i){for(var n=0;n<a.length;n++)r.cache.remove(a[n]);s.$success([h,e])},l=function(t,e){s.$failure([h,0,e])};try{for(var p=0;p<e.length;p++){var m=g(e[p]);this.cache.has(m)&&(a[p]=m,h[p]=this.cache.get(m),c[p]="?")}u=t(d,[this.name,c.join(",")])}catch($){s.$failure([h,$])}return s.$pending()&&this.db.transaction(o,l),s},_size:function(t){var e=this,i=function(e,i){t.$failure([i])},n=function(t){t.executeSql(e.SQL_COUNT,[],s,i)},s=function(e,i){t.$success([i.rows[0].count])};this.db.readTransaction(n,i)}}}),d.adapter("window-name",2,function(){function t(){if(!t.cache)try{t.cache=m(window.top.name)}catch(e){t.cache={}}return t.cache}function e(){try{window.top.name=g(t())}catch(e){}}return{encode:function(t){return this.prefix+g(t)},decode:function(t){return m(t.substring(this.prefix.length))},valid:function(){return window.top&&"undefined"!=typeof window.top.name},init:function(t,e,i){var n=new v(this,e,i);return this.prefix=h(t.prefix,this.name+"-"),n.$bindTo(this.reload(),[this]),n},reload:function(e,i){var n=new v(this,e,i),s=this.prefix,r=new p,a=t();try{for(var h in a)if(h.substring(0,s.length)===s){var c=a[h],u=m(c),o=this.decode(h);r.put(h,u,o)}this.cache=r,this.loaded=!0}catch(f){n.$failure([f])}return this.finishReload(n),n},_destroy:function(i){for(var n=this.cache.keys,s=t(),r=0;r<n.length;r++)delete s[n[r]];this.cache.reset(),e(),i.$success()},_put:function(i,n,s,r,a){var h=t(),c=this.cache.get(s);h[s]=n,this.cache.put(s,n,i),e(),a.$success([i,n,c])},_remove:function(i,n,s,r){var a=t();delete a[n],this.cache.remove(n),e(),r.$success([s,i])}}}),t.Stork=d,t.Stork.getAdapter=l,t.Stork.Promise=v,t.Stork.FastMap=p}(window);
//# sourceMappingURL=stork.min.js.map
