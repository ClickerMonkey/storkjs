"use strict";!function(t,e){function n(t){return!!(t&&t.constructor&&t.call&&t.apply)}function i(t){return"object"==typeof t&&null!==t}function s(t){return"number"==typeof t&&!isNaN(t)}function r(t){return t instanceof Array}function a(t){return"string"==typeof t}function c(t){return"undefined"==typeof t}function u(t){return"undefined"!=typeof t}function o(t,e,n,i){return u(t)?t:u(e)?e:u(n)?n:i}function h(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function f(t,e){for(var n in t)e[n]=t[n];return e}function l(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function d(){return l()+l()+"-"+l()+"-"+l()+"-"+l()+"-"+l()+l()+l()}function v(t,e){var n=e.priority-t.priority;return 0===n?0:0>n?-1:1}function p(t,e){return function(){var n=new $(this,success,failure);if(this.handlePending(this[t],arguments,n))return n;var i=Array.prototype.slice.call(arguments);return i.pop(),i.pop(),i.push(n),e.apply(this,i),n}}function g(t){if(t)for(var e=0;e<m.adapters.length;e++){var n=m.adapters[e];if(n.name===t&&n.definition.valid())return n}if(!g.chosen){m.adapters.sort(v);for(var e=0;e<m.adapters.length;e++){var n=m.adapters[e];if(n.definition.valid())return g.chosen=n}}return g.chosen}function m(t,e,n){if(!(this instanceof m))return new m(t,e,n);if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";this.options=t=t||{},this.key=o(t.key,"id"),this.name=o(t.name,""),this.lazy=o(t.lazy,!1),this.cache=new y,this.pending=[],this.initialized=!1,this.loaded=!1,this.adapter=g(t.adapter),f(this.adapter.definition,this);for(var i=0;i<m.plugins.length;i++)m.plugins[i](this);this.initializing=this.init(this.options,e,n)}function $(t,e,n,i){this.context=t,this.root=i||this,this.next=null,this.nextFromSuccess=null,this.state=$.PENDING,this.successes=[],this.failures=[],this.errors=[],this.args=null,this.$queue(e,n)}function y(t){this.reset(),this.putMap(t)}var w=JSON.stringify,S=JSON.parse;m.prototype={decode:S,encode:w,handlePending:function(t,e,n){var i=!this.initialized;return i&&this.pending.push({method:t,arguments:Array.prototype.slice.call(e),promise:n}),i},finishInitialization:function(t,e){if(!this.initialized){this.initialized=!0,t.$success(e);for(var n=0;n<this.pending.length;n++){var i=this.pending[n],s=i.method.apply(this,i.arguments);i.promise&&i.promise.$bindTo(s)}this.pending=null}return this},finishReload:function(t){if(t.$pending()){var e=this.cache;this.initialized?t.$success([e.values,e.okeys]):this.finishInitialization(t,[e.values,e.okeys])}},valid:function(){throw"Stork.valid is not implemented"},init:function(t,e,n){throw"Stork.init is not implemented"},reload:function(t,e){throw"Stork.reload is not implemented"},then:function(t){return t.apply(this)},getMany:function(t,e,n){var i=new $(this,e,n);if(this.handlePending(this.getMany,arguments,i))return i;for(var s=0,r=[],a=function(e){return function(n){r[e]=n,++s===t.length&&i.$success([r,t])}},c=function(e){i.$failure([t,e])},u=0;u<t.length;u++)this.get(t[u],a(u),c);return i},get:function(t,n,i){var s=new $(this,n,i);if(this.handlePending(this.get,arguments,s))return s;var r;try{r=this.encode(t)}catch(a){s.$failure([t,a])}return s.$pending()&&(this.cache.has(r)?s.$success([this.cache.get(r),t]):this.loaded?s.$success([e,t]):this._get(t,r,s)),s},_get:function(t,e,n){throw"Stork._get is not implemented"},destroy:function(t,e){var n=new $(this,t,e);return this.handlePending(this.destroy,arguments,n)?n:(this._destroy(n),n)},_destroy:function(t){throw"Stork._destroy is not implemented"},save:function(t,e,n){var i=new $(this,e,n);if(this.handlePending(this.save,arguments,i))return i;var s=this.key,r=t[s];c(r)&&(r=t[s]=d());var a=function(t,e){i.$success([e])},u=function(t,e,n){i.$failure([e,n])};return this.put(r,t,a,u),i},batch:function(t,e,n){var i=new $(this,e,n);if(this.handlePending(this.batch,arguments,i))return i;for(var s=0,r=function(){++s===t.length&&i.$success([t])},a=function(e){i.$failure([t,s,e])},c=0;c<t.length&&!i.state;c++)this.save(t[c],r,a);return i},put:function(t,e,n,i){var s=new $(this,n,i);if(this.handlePending(this.put,arguments,s))return s;var r,a;try{r=this.encode(t),a=w(e)}catch(c){s.$failure([t,e,c])}return s.$pending()&&this._put(t,e,r,a,s),s},_put:function(t,e,n,i,s){throw"Stork._put is not implemented"},remove:function(t,n,i){var s=new $(this,n,i);if(this.handlePending(this.remove,arguments,s))return s;var r;try{r=this.encode(t)}catch(a){s.$failure([t,a])}if(s.$pending())if(this.loaded&&!this.cache.has(r))s.$success([e,t]);else{var c=this.cache.get(r);this._remove(t,r,c,s)}return s},_remove:function(t,e,n,i){throw"Stork._remove is not implemented"},removeMany:function(t,e,n){var i=new $(this,e,n);if(this.handlePending(this.removeMany,arguments,i))return i;for(var s=[],r=0,a=function(e){return function(n){s[e]=n,++r===t.length&&i.$success([s,t])}},c=function(t){i.$failure([s,r,t])},u=0;u<t.length;u++)this.remove(t[u],a(u),c);return i},each:function(t,e){if(!n(t)||this.handlePending(this.each,arguments))return this;var i=this,s=function(e,n){for(var s=0;s<e.length;s++)t.call(i,e[s],n[s])};if(this.loaded){var r=this.cache.okeys,a=this.cache.values;s(a,r)}else this.reload(s,e);return this},size:function(t,e){var n=new $(this,t,e);return this.handlePending(this.size,arguments,n)?n:(this.loaded?n.$success([this.cache.size()]):this._size(n),n)},_size:function(t){throw"Stork._size is not implemented"},all:function(t,e){var n=new $(this,t,e);if(this.handlePending(this.all,arguments,n))return n;var i=function(t,e){n.$success([t,e])},s=function(t){n.$failure([t])};if(this.loaded){var r=this.cache.okeys,a=this.cache.values;i(a,r)}else this.reload(i,s);return n}},$.PENDING=0,$.FAILURE=1,$.SUCCESS=2,$.CHAINED=3,$.prototype={then:function(t,n){return this.$queue(t,n),this.next||(this.next=new $(this.context,e,e,this)),this.state&$.SUCCESS?this.$handleSuccesses():this.state===$.FAILURE&&this.$handleFailures(),this.next},error:function(t){return n(t)&&(this.root.errors.push(t),this.state===$.FAILURE&&this.$handleFailures()),this},$bindTo:function(t,e){var n=this;t.then(function(){n.context=t.context,n.$success(o(e,t.args))},function(){n.context=t.context,n.$failure(o(e,t.args))})},$pending:function(){return this.state===$.PENDING},$queue:function(t,e){n(t)&&this.successes.push(t),n(e)&&this.failures.push(e)},$handleSuccesses:function(){for(var t=this.successes,e=0;e<t.length;e++){var n=t[e],i=n.apply(this.context,this.args);i instanceof $&&!this.nextFromSuccess&&(this.nextFromSuccess=i)}t.length=0,this.$handleNext()},$handleNext:function(){var t=this.next,e=this.nextFromSuccess;t&&e&&this.state===$.SUCCESS&&(t.$bindTo(e),this.state=$.CHAINED)},$success:function(t){this.state===$.PENDING&&(this.args=t||[],this.state=$.SUCCESS,this.$handleSuccesses())},$handleFailures:function(){for(var t=this.failures,e=0;e<t.length;e++)t[e].apply(this.context,this.args);t.length=0;for(var n=this.root.errors,i=[this.args[this.args.length-1]],e=0;e<n.length;e++)n[e].apply(this.context,i);n.length=0},$failure:function(t){this.state===$.PENDING&&(this.args=t||[],this.state=$.FAILURE,this.$handleFailures())},$reset:function(){this.state=$.PENDING,this.successes.length=0,this.failures.length=0,this.errors.length=0}},y.prototype={reset:function(){return this.values=[],this.keys=[],this.okeys=[],this.indices={},this},put:function(t,e,n){return t in this.indices?this.values[this.indices[t]]=e:(this.indices[t]=this.values.length,this.values.push(e),this.keys.push(t),this.okeys.push(n)),this},putMap:function(t){if(t instanceof y)for(var e=t.keys,n=t.values,s=t.okeys,r=0;r<e.length;r++)this.put(e[r],n[r],s[r]);else if(i(t))for(var a in t)this.put(a,t[a],a);return this},get:function(t){return this.values[this.indices[t]]},remove:function(t){var e=this.indices[t];return s(e)&&this.removeAt(e),this},removeAt:function(t){var e=this.keys[t],n=this.values.pop(),i=this.keys.pop(),s=this.okeys.pop();return t<this.values.length&&(this.values[t]=n,this.keys[t]=i,this.okeys[t]=s,this.indices[i]=t),delete this.indices[e],this},indexOf:function(t){return o(this.indices[t],-1)},has:function(t){return t in this.indices},hasOverlap:function(t){for(var e=this.keys,n=t.indices,i=0;i<e.length;i++)if(e[i]in n)return!0;return!1},size:function(){return this.values.length},reverse:function(){for(var t=this.size()-1,e=Math.ceil(t/2),n=0;e>n;n++)h(this.values,n,t-n),h(this.keys,n,t-n),h(this.okeys,n,t-n);return this.rebuildIndex(),this},sort:function(t){function e(e,n){for(var s=i.values[Math.floor((n+e)/2)],r=e,a=n;a>=r;){for(;t(i.values[r],s)<0;)r++;for(;t(i.values[a],s)>0;)a--;a>=r&&(h(i.values,r,a),h(i.keys,r,a),h(i.okeys,r,a),r++,a--)}return r}function n(t,i){var s=e(t,i);s-1>t&&n(t,s-1),i>s&&n(s,i)}var i=this,s=this.size()-1;return s>0&&(n(0,s),this.rebuildIndex()),this},rebuildIndex:function(){this.indices={};for(var t=0;t<=right;t++)this.indices[this.keys[t]]=t;return this}},m.plugins=[],m.plugin=function(t){return n(t)&&m.plugins.push(t),m},m.adapters=[],m.adapter=function(t,e,i){return m.adapters.push({name:t,priority:e,definition:n(i)?i():i}),m},m.plugin(function(){function t(t,e,n,s){var r=function(r,a){for(var c=0;c<r.length;c++){var u=r[c];i(u)&&t in u&&e(u[t])}s.$success([n()])},a=function(t){s.$failure([t])};this.all(r,a)}function e(e,n){var i=0,s=function(t){i++},r=function(){return i};t(e,s,r,n)}function n(e,n){var i=0,r=function(t){s(t)&&(i+=t)},a=function(){return i};t(e,r,a,n)}function r(e,n){var i=0,r=0,a=function(t){s(t)&&(i+=t,r++)},c=function(){return i/r};t(e,a,c,n)}function a(e,n){var i=Number.MAX_VALUE,r=function(t){s(t)&&(i=Math.min(i,t))},a=function(){return i};t(e,r,a,n)}function c(e,n){var i=Number.MAX_VALUE,r=function(t){s(t)&&(i=Math.min(i,t))},a=function(){return i};t(e,r,a,n)}var u={aggregate:p("aggregate",t),count:p("count",e),sum:p("sum",n),avg:p("avg",r),min:p("min",a),max:p("max",c)};return function(t){f(u,t)}}()),m.plugin(function(){function t(t,e){var n=function(n,i){for(var s=[],r=[],a=0;a<n.length;a++){var c=n[a],u=i[a];t(c,u)&&(r.push(c),s.push(u))}e.$success([r,s])},i=function(t){e.$failure([t])};this.all(n,i)}function e(t,e){var n=function(n,s){for(var c=[],u=[],o=0;o<n.length;o++){var h=n[o];if(i(h))if(a(t))t in h&&(c.push(h[t]),u.push(s[o]));else if(r(t)){for(var f={},l=0,d=0;d<t.length;d++){var v=t[d];v in h&&(f[v]=h[v],l++)}l>0&&(c.push(f),u.push(s[o]))}}e.$success([c,u])},s=function(n){e.$failure([t,n])};this.all(n,s)}function n(t,e,n){var i=function(){var i=this.cache;i.sort(t),e&&i.reverse(),n.$success([i.values,i.okeys])},s=function(t){n.$failure([t])};this.all(i,s)}var s={where:p("where",t),select:p("select",e),sort:p("sort",n)};return function(t){f(s,t)}}()),m.adapter("chrome-storage-local",4,function(){function t(){return chrome&&chrome.runtime&&chrome.runtime.lastError}var n=window.chrome&&chrome.storage?chrome.storage.local:!1;return{encode:function(t){return this.prefix+w(t)},decode:function(t){return S(t.substring(this.prefix.length))},valid:function(){if(!n)return!1;try{var t=Math.random(),e={};return e[t]=t,n.set(e),n.remove(t),!0}catch(i){return!1}},init:function(t,e,n){var i=new $(this,e,n);return this.prefix=o(t.prefix,this.name+"-"),this.lazy?this._finishInitialization(i,[this]):i.$bindTo(this.reload(),[this]),i},reload:function(e,i){var s=new $(this,e,i),r=this,a=this.prefix,c=new y;return n.get(null,function(e){if(t())s.$failure([t()]);else{for(var n in e)n.substring(0,a.length)===a&&c.put(n,e[n],r.decode(n));r.cache=c,r.loaded=!0,r.finishReload(s)}}),s},_get:function(i,s,r){var a=this;n.get(s,function(n){if(t())r.$failure([i,t()]);else if(n.length){var c=S(n[0]);a.cache.put(s,c,i),r.$success([c,i])}else r.$success([e,i])})},_destroy:function(e){var i=this,s=function(){n.remove(this.cache.keys,function(){t()?e.$failure([t()]):(i.cache.reset(),e.$success())})},r=function(t){e.$failure([t])};this.loaded?s():this.reload(s,r)},_put:function(e,i,s,r,a){var c=this,u={};u[s]=i,n.set(u,function(){if(t())a.$failure([e,i,t()]);else{var n=c.cache.get(s);c.cache.put(s,i,e),a.$success([e,i,n])}})},_remove:function(e,i,s,r){var a=this;n.remove(i,function(){t()?r.$failure([e,t()]):(a.cache.remove(i),r.$success([s,e]))})},_size:function(t){var e=function(e,n){t.$success([e.length])},n=function(e){t.$failure([e])};this.reload(e,n)}}}),m.adapter("ie-userdata",1.5,{valid:function(){return u(document.body.addBehavior)},init:function(t,e,n){var i=new $(this,e,n),s=document.createElement("span");return s.style.behavior="url('#default#userData')",s.style.position="absolute",s.style.left=1e4,document.body.appendChild(s),this.store=s,this.store.load(this.name),this.lazy?this.finishInitialization(i,[this]):i.$bindTo(this.reload(),[this]),i},reload:function(t,e){for(var n=new $(this,t,e),i=this.store.XMLDocument.firstChild.attributes,s=new y,r=0;r<i.length;r++)try{var a=i[r],c=a.nodeName,u=a.nodeValue,o=this.decode(c),h=S(u);s.put(c,h,o)}catch(f){}return this.cache=s,this.loaded=!0,this.finishReload(n),n},_get:function(t,n,i){var s=this.store.getAttribute(n);if(null===s)i.$success([e,t]);else{var r=null;try{r=S(s)}catch(a){i.$failure([a])}i.$pending()&&(this.cache.put(n,r,t),i.$success([r,t]))}},_destroy:function(t){for(var e=this.store.XMLDocument.firstChild.attributes,n=0;n<e.length;n++)this.store.removeAttribute(e[n].nodeName);this.cache.reset(),t.$success()},_put:function(t,e,n,i,s){var r=this.cache.get(n);try{this.store.setAttribute(n,i)}catch(a){s.$failure([t,e,a])}s.$pending()&&(this.cache.put(n,e,t),s.$success([t,e,r]))},_remove:function(t,e,n,i){this.store.removeAttribute(e),this.cache.remove(e),i.$success([n,t])}}),m.adapter("indexed-db",5,function(){var t=function(){return window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB},n=function(){return window.IDBTransaction||window.webkitIDBTransaction||window.mozIDBTransaction||window.oIDBTransaction||window.msIDBTransaction},i=3,s=n()&&"READ_WRITE"in n()?n().READ_WRITE:"readwrite";return{valid:function(){return!!t()},init:function(e,n,s){var r=new $(this,n,s),a=this,c=t(),u=c.open(this.name,i);return u.onerror=function(t){r.$failure([t])},u.onupgradeneeded=function(){a.db=u.result,a.db.createObjectStore(a.name,{keyPath:this.key})},u.onsuccess=function(t){a.db=u.result,a.lazy?a.finishInitialization(r,[a]):r.$bindTo(a.reload(),[a])},r},reload:function(t,e){var n=new $(this,t,e),i=this,s=this.db.transaction(this.name).objectStore(this.name),r=s.openCursor(),a=new y;return r.onsuccess=function(t){var e=r.result;if(e){var s=e.key,c=e.value,u=i.decode(s);a.put(s,c,u),e["continue"]()}else i.cache=a,i.loaded=!0,i.finishReload(n,[a.values,a.okeys])},r.onerror=function(t){n.$failure([keys,t])},n},_destroy:function(t){var e=this,n=this.db.transaction(this.name,s).objectStore(this.name);n.transaction.oncomplete=function(){e.cache.reset(),t.$success()},n.transaction.onabort=function(e){t.$failure([e])},n.clear()},_get:function(t,n,i){var s=this,r=this.db.transaction(this.name).objectStore(this.name),a=r.get(n);a.onsuccess=function(r){if(a.result===e)i.$success([e,t]);else{var c=a.result;s.cache.put(n,c,t),i.$success([c,t])}},a.onerror=function(){i.$failure([t,a.error])}},_put:function(t,e,n,i,r){var a=this,c=this.db.transaction(this.name,s).objectStore(this.name);c.transaction.oncomplete=function(){var i=a.cache.get(n);a.cache.put(n,e,t),r.$success([t,e,i])},c.transaction.onabort=function(n){r.$failure([t,e,n])},c.put(e,n)},_remove:function(t,e,n,i){var r=this,a=this.db.transaction(this.name,s).objectStore(this.name);a.transaction.oncomplete=function(){r.cache.remove(e),i.$success([n,t])},a.transaction.onabort=function(e){i.$failure([t,e])},a["delete"](e)},_size:function(t){var e=this.db.transaction(this.name,s).objectStore(this.name),n=e.count();n.onsuccess=function(){t.$success([n.result])},n.onerror=function(e){t.$failure([n.error])}}}}),m.adapter("local-storage",3,function(){var t=window.localStorage;return{encode:function(t){return this.prefix+w(t)},decode:function(t){return S(t.substring(this.prefix.length))},valid:function(){if(!t)return!1;try{var e=Math.random();return t.setItem(e,e),t.removeItem(e),!0}catch(n){return!1}},init:function(t,e,n){var i=new $(this,e,n);return this.prefix=o(t.prefix,this.name+"-"),this.lazy?this.finishInitialization(i,[this]):i.$bindTo(this.reload(),[this]),i},reload:function(e,n){var i=new $(this,e,n),s=this.prefix,r=new y;try{for(var a=0;a<t.length;a++){var c=t.key(a);if(c.substring(0,s.length)===s){var u=t.getItem(c),o=S(u),h=this.decode(c);r.put(c,o,h)}}this.cache=r,this.loaded=!0}catch(f){i.$failure([f])}return this.finishReload(i),i},_destroy:function(e){var n=this,i=this.prefix,s=function(i){try{for(var s=0;s<i.length;s++)t.removeItem(i[s])}catch(r){e.$failure([r])}e.$pending()&&(n.cache.reset(),e.$success())};if(this.loaded)s(this.cache.keys);else{var r=[];try{for(var a=0;a<t.length;a++){var c=t.key(a);c.substring(0,i.length)===i&&r.push(c)}}catch(u){e.$failure([u])}e.$pending()&&s(r)}},_get:function(n,i,s){try{var r=t.getItem(i);if(null===r)s.$success([e,n]);else{var a=S(r);this.cache.put(i,a,n),s.$success([a,n])}}catch(c){s.$failure([n,c])}},_put:function(e,n,i,s,r){try{t.setItem(i,s)}catch(a){r.$failure([e,n,a])}if(r.$pending()){var c=this.cache.get(i);this.cache.put(i,n,e),r.$success([e,n,c])}},_remove:function(e,n,i,s){try{t.removeItem(n)}catch(r){s.$failure([e,r])}s.$pending()&&(this.cache.remove(n),s.$success([i,e]))},_size:function(t){var e=function(e,n){t.$success([e.length])},n=function(e){t.$failure([e])};this.reload(e,n)}}}),m.adapter("memory",1,{valid:function(){return!0},init:function(t,e,n){var i=new $(this,e,n);return this.loaded=!0,this.finishInitialization(i,[this]),i},reload:function(t,e){var n=new $(this,t,e);return this.finishReload(n),n},_destroy:function(t){this.cache.reset(),t.$success()},_put:function(t,e,n,i,s){var r=this.cache.get(n);this.cache.put(n,e,t),s.$success([t,e,r])},_remove:function(t,e,n,i){this.cache.remove(e),i.$success([n,t])}}),m.adapter("webkit-sqlite",6,function(){function t(t,e){return t.replace(/\{(\d+)\}/g,function(t,n){return n=parseInt(n),isNaN(n)||0>n||n>=e.length?t:e[n]})}var n="stork",i="CREATE TABLE IF NOT EXISTS {0} (id TEXT PRIMARY KEY, value TEXT)",s="SELECT value FROM {0} WHERE id = ?",r="SELECT id, value FROM {0}",a="SELECT id, value FROM {0} WHERE id IN ({1})",u="INSERT OR REPLACE INTO {0} (id, value) VALUES (?, ?)",h="DELETE FROM {0} WHERE id = ?",f="SELECT COUNT(*) as count FROM {0}",l="DELETE FROM {0}",v="DELETE FROM {0} WHERE id IN ({1})";return{valid:function(){return!!window.openDatabase},init:function(e,a,c){var d=new $(this,a,c),v=o(e.database,n),p=o(e.size,65536),g=o(e.version,"1.0"),m=this,y=function(t,e){d.$failure([e])},w=function(t){t.executeSql(m.SQL_CREATE,[],S,y)},S=function(t,e){m.lazy?m.finishInitialization(d,[m]):d.$bindTo(m.reload(),[m])};return this.SQL_CREATE=t(i,[this.name]),this.SQL_SELECT=t(s,[this.name]),this.SQL_SELECT_ALL=t(r,[this.name]),this.SQL_INSERT=t(u,[this.name]),this.SQL_DELETE=t(h,[this.name]),this.SQL_DESTROY=t(l,[this.name]),this.SQL_COUNT=t(f,[this.name]),this.db=openDatabase(v,g,v,p),this.db.transaction(w,y),d},reload:function(t,e){var n=new $(this,t,e),i=this,s=function(t,e){n.$failure([e])},r=function(t){t.executeSql(i.SQL_SELECT_ALL,[],a,s)},a=function(t,e){var s=new y;try{for(var r=0;r<e.rows.length;r++){var a=e.rows[r],c=S(a.value),u=S(a.id);s.put(a.id,c,u)}i.cache=s,i.loaded=!0}catch(o){n.$failure([o])}i.finishReload(n)};return this.db.readTransaction(r,s),n},_get:function(t,n,i){var s=this,r=function(e,n){i.$failure([t,n])},a=function(t){t.executeSql(s.SQL_SELECT,[n],c,r)},c=function(r,a){var c=e;try{var u=a.rows[0];u&&u.value!==e&&(c=S(u.value))}catch(o){i.$failure([t,o])}i.$pending()&&(c!==e?(s.cache.put(n,c,t),i.$success([c,t])):i.$success([e,t]))};this.db.readTransaction(a,r)},_destroy:function(t){var e=this,n=function(t){t.executeSql(e.SQL_DESTROY,[],i,s)},i=function(n,i){e.cache.reset(),t.$success()},s=function(e,n){t.$failure([n])};this.db.transaction(n,s)},_put:function(t,e,n,i,s){var r=this,a=function(t){t.executeSql(r.SQL_INSERT,[n,i],c,u)},c=function(i,a){var c=r.cache.get(n);r.cache.put(n,e,t),s.$success([t,e,c])},u=function(n,i){s.$failure([t,e,i])};this.db.transaction(a,u)},_remove:function(t,e,n,i){var s=this,r=function(t){t.executeSql(s.SQL_DELETE,[e],a,c)},a=function(r,a){s.cache.remove(e),i.$success([n,t])},c=function(e,n){i.$failure([t,n])};this.db.transaction(r,c)},_size:function(t){var e=this,n=function(e,n){t.$failure([n])},i=function(t){t.executeSql(e.SQL_COUNT,[],s,n)},s=function(e,n){t.$success([n.rows[0].count])};this.db.readTransaction(i,n)},batch:function(t,e,n){var i=new $(this,e,n);if(this.handlePending(this.batch,arguments,i))return i;var s=this,r=this.key,a=0,u=[];try{for(var o=0;o<t.length;o++){var h=t[o],f=h[r];c(f)&&(f=h[r]=d()),u.push({value:h,key:f,rawKey:w(f),rawValue:w(h)})}}catch(l){return i.$failure([t,a,l]),i}var v=function(t){for(var e=0;e<u.length;e++){var n=u[e];t.executeSql(s.SQL_INSERT,[n.rawKey,n.rawValue],p,g)}},p=function(e,n){if(++a===t.length&&i.$pending()){for(var r=0;r<u.length;r++){var c=u[r];s.cache.put(c.rawKey,c.value,c.key)}i.$success([t])}},g=function(e,n){i.$failure([t,a,n])};return this.db.transaction(v,g),i},removeMany:function(e,n,i){var s=new $(this,n,i);if(this.handlePending(this.removeMany,arguments,s))return s;var r=this,a=[],c=[],u=[],o="",h=function(t){t.executeSql(o,a,f,l)},f=function(t,n){for(var i=0;i<a.length;i++)r.cache.remove(a[i]);s.$success([c,e])},l=function(t,e){s.$failure([c,0,e])};try{for(var d=0;d<e.length;d++){var p=w(e[d]);this.cache.has(p)&&(a[d]=p,c[d]=this.cache.get(p),u[d]="?")}o=t(v,[this.name,u.join(",")])}catch(g){s.$failure([c,g])}return s.$pending()&&this.db.transaction(h,l),s},getMany:function(e,n,i){var s=new $(this,n,i);if(this.handlePending(this.removeMany,arguments,s))return s;var r=this,c=[],u=[],o=[],h=[],f="",l=function(t){t.executeSql(f,c,d,v)},d=function(t,n){for(var i=0;i<n.rows.length;i++)for(var a=n.rows[i],h=0;h<c.length;h++)if(c[h]===a.id){var f=S(a.value),l=u[h];o[l]=f,r.cache.put(a.id,f,e[l])}s.$success([o,e])},v=function(t,n){s.$failure([e,n])};try{for(var p=0;p<e.length;p++){var g=w(e[p]);this.cache.has(g)?o[p]=this.cache.get(g):(c.push(g),u.push(p),h.push("?"))}f=t(a,[this.name,h.join(",")])}catch(m){s.$failure([o,m])}return s.$pending()&&(c.length?this.db.transaction(l,v):s.$success([o,e])),s}}}),m.adapter("window-name",2,function(){function t(){if(!t.cache)try{t.cache=S(window.top.name)}catch(e){t.cache={}}return t.cache}function e(){try{window.top.name=w(t())}catch(e){}}return{encode:function(t){return this.prefix+w(t)},decode:function(t){return S(t.substring(this.prefix.length))},valid:function(){return window.top&&"undefined"!=typeof window.top.name},init:function(t,e,n){var i=new $(this,e,n);return this.prefix=o(t.prefix,this.name+"-"),i.$bindTo(this.reload(),[this]),i},reload:function(e,n){var i=new $(this,e,n),s=this.prefix,r=new y,a=t();try{for(var c in a)if(c.substring(0,s.length)===s){var u=a[c],o=S(u),h=this.decode(c);r.put(c,o,h)}this.cache=r,this.loaded=!0}catch(f){i.$failure([f])}return this.finishReload(i),i},_destroy:function(n){for(var i=this.cache.keys,s=t(),r=0;r<i.length;r++)delete s[i[r]];this.cache.reset(),e(),n.$success()},_put:function(n,i,s,r,a){var c=t(),u=this.cache.get(s);c[s]=i,this.cache.put(s,i,n),e(),a.$success([n,i,u])},_remove:function(n,i,s,r){var a=t();delete a[i],this.cache.remove(i),e(),r.$success([s,n])}}}),t.Stork=m,t.Stork.getAdapter=g,t.Stork.Promise=$,t.Stork.FastMap=y}(window);
//# sourceMappingURL=stork.min.js.map
